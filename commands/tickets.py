import discord
from discord.ext import commands
from discord import app_commands
import json
import os
from datetime import datetime, timezone
import asyncio
import io

def load_tickets_config():
    if os.path.exists("tickets_config.json"):
        with open("tickets_config.json", "r") as file:
            data = json.load(file)
            default_config = {
                "enabled": False,
                "category_id": 0,
                "logs_channel_id": 0,
                "staff_role_id": 0,
                "support_role_id": 0,
                "panel_channel_id": 0,
                "panel_message_id": 0,
                "ticket_counter": 0,
                "max_tickets_per_user": 3,
                "auto_close_inactive": False,
                "inactive_hours": 24,
                "ticket_categories": {
                    "general": {
                        "name": "Support G√©n√©ral",
                        "emoji": "üé´",
                        "description": "Questions g√©n√©rales et aide"
                    },
                    "bug": {
                        "name": "Report de Bug",
                        "emoji": "üêõ",
                        "description": "Signaler un probl√®me technique"
                    },
                    "other": {
                        "name": "Autre",
                        "emoji": "‚ùì",
                        "description": "Autres demandes"
                    }
                }
            }
            return {**default_config, **data}
    return {
        "enabled": False,
        "category_id": 0,
        "logs_channel_id": 0,
        "staff_role_id": 0,
        "support_role_id": 0,
        "panel_channel_id": 0,
        "panel_message_id": 0,
        "ticket_counter": 0,
        "max_tickets_per_user": 3,
        "auto_close_inactive": False,
        "inactive_hours": 24,
        "ticket_categories": {
            "general": {
                "name": "Support G√©n√©ral",
                "emoji": "üé´",
                "description": "Questions g√©n√©rales et aide"
            },
            "bug": {
                "name": "Report de Bug",
                "emoji": "üêõ",
                "description": "Signaler un probl√®me technique"
            },
            "other": {
                "name": "Autre",
                "emoji": "‚ùì",
                "description": "Autres demandes"
            }
        }
    }

def save_tickets_config(config):
    with open("tickets_config.json", "w") as file:
        json.dump(config, file, indent=2)

def load_active_tickets():
    if os.path.exists("active_tickets.json"):
        with open("active_tickets.json", "r") as file:
            return json.load(file)
    return {}

def save_active_tickets(data):
    with open("active_tickets.json", "w") as file:
        json.dump(data, file, indent=2)

class TicketPanel(discord.ui.View):
    def __init__(self):
        super().__init__(timeout=None)

    @discord.ui.button(label="Support G√©n√©ral", style=discord.ButtonStyle.primary, emoji="üé´", custom_id="ticket_general")
    async def general_ticket(self, interaction: discord.Interaction, button: discord.ui.Button):
        await self.create_ticket(interaction, "general")

    @discord.ui.button(label="Report de Bug", style=discord.ButtonStyle.danger, emoji="üêõ", custom_id="ticket_bug")
    async def bug_ticket(self, interaction: discord.Interaction, button: discord.ui.Button):
        await self.create_ticket(interaction, "bug")

    @discord.ui.button(label="Autre", style=discord.ButtonStyle.secondary, emoji="‚ùì", custom_id="ticket_other")
    async def other_ticket(self, interaction: discord.Interaction, button: discord.ui.Button):
        await self.create_ticket(interaction, "other")

    async def create_ticket(self, interaction: discord.Interaction, category: str):
        config = load_tickets_config()

        if not config["enabled"]:
            await interaction.response.send_message("‚ùå Le syst√®me de tickets est d√©sactiv√©.", ephemeral=True)
            return

        # V√©rifier si l'utilisateur a d√©j√† trop de tickets ouverts
        active_tickets = load_active_tickets()
        user_tickets = [t for t in active_tickets.values() if t["user_id"] == interaction.user.id and t["status"] == "open"]

        if len(user_tickets) >= config["max_tickets_per_user"]:
            await interaction.response.send_message(f"‚ùå Vous avez d√©j√† {config['max_tickets_per_user']} ticket(s) ouvert(s). Fermez-en un avant d'en cr√©er un nouveau.", ephemeral=True)
            return

        guild = interaction.guild
        category_channel = guild.get_channel(config["category_id"])

        if not category_channel:
            await interaction.response.send_message("‚ùå Cat√©gorie de tickets non configur√©e.", ephemeral=True)
            return

        # Incr√©menter le compteur de tickets
        config["ticket_counter"] += 1
        ticket_number = config["ticket_counter"]
        save_tickets_config(config)

        # Cr√©er le canal du ticket
        ticket_name = f"ticket-{ticket_number:04d}"

        # Permissions du ticket
        overwrites = {
            guild.default_role: discord.PermissionOverwrite(read_messages=False, send_messages=False),
            interaction.user: discord.PermissionOverwrite(read_messages=True, send_messages=True, attach_files=True, embed_links=True),
            guild.me: discord.PermissionOverwrite(read_messages=True, send_messages=True, manage_channels=True, manage_messages=True)
        }

        # Ajouter les r√¥les staff/support
        if config["staff_role_id"]:
            staff_role = guild.get_role(config["staff_role_id"])
            if staff_role:
                overwrites[staff_role] = discord.PermissionOverwrite(read_messages=True, send_messages=True, manage_messages=True)

        if config["support_role_id"]:
            support_role = guild.get_role(config["support_role_id"])
            if support_role:
                overwrites[support_role] = discord.PermissionOverwrite(read_messages=True, send_messages=True)

        try:
            ticket_channel = await guild.create_text_channel(
                ticket_name,
                category=category_channel,
                overwrites=overwrites,
                reason=f"Ticket cr√©√© par {interaction.user}"
            )

            # Enregistrer le ticket
            ticket_data = {
                "channel_id": ticket_channel.id,
                "user_id": interaction.user.id,
                "category": category,
                "status": "open",
                "created_at": datetime.now(timezone.utc).isoformat(),
                "claimed_by": None,
                "messages": []
            }

            active_tickets[str(ticket_channel.id)] = ticket_data
            save_active_tickets(active_tickets)

            # Cr√©er l'embed d'accueil
            category_info = config["ticket_categories"].get(category, config["ticket_categories"]["general"])
            embed = discord.Embed(
                title=f"{category_info['emoji']} {category_info['name']} - Ticket #{ticket_number:04d}",
                description=f"Bonjour {interaction.user.mention} !\n\nVotre ticket a √©t√© cr√©√© avec succ√®s. Un membre du staff va vous aider bient√¥t.\n\n**Cat√©gorie:** {category_info['description']}",
                color=discord.Color.blue(),
                timestamp=datetime.now(timezone.utc)
            )
            embed.add_field(name="üìã Instructions", value="‚Ä¢ D√©crivez votre probl√®me en d√©tail\n‚Ä¢ Restez poli et patient\n‚Ä¢ Utilisez les boutons ci-dessous pour les actions", inline=False)
            embed.set_footer(text=f"Ticket de {interaction.user.display_name}", icon_url=interaction.user.display_avatar.url)

            # Vue avec boutons de gestion
            view = TicketManagement()

            welcome_msg = await ticket_channel.send(f"{interaction.user.mention}", embed=embed, view=view)

            # Pin le message d'accueil
            await welcome_msg.pin()

            await interaction.response.send_message(f"‚úÖ Votre ticket a √©t√© cr√©√© ! {ticket_channel.mention}", ephemeral=True)

            # Log la cr√©ation
            await self.log_ticket_action(guild, "create", interaction.user, ticket_channel, category_info["name"])

        except discord.Forbidden:
            await interaction.response.send_message("‚ùå Je n'ai pas les permissions pour cr√©er le ticket.", ephemeral=True)
        except Exception as e:
            await interaction.response.send_message(f"‚ùå Erreur lors de la cr√©ation du ticket: {str(e)}", ephemeral=True)

    async def log_ticket_action(self, guild, action, user, channel, extra_info=""):
        config = load_tickets_config()
        if config["logs_channel_id"] == 0:
            return

        logs_channel = guild.get_channel(config["logs_channel_id"])
        if not logs_channel:
            return

        action_colors = {
            "create": discord.Color.green(),
            "close": discord.Color.red(),
            "claim": discord.Color.blue(),
            "unclaim": discord.Color.orange()
        }

        action_titles = {
            "create": "üé´ Ticket Cr√©√©",
            "close": "üîí Ticket Ferm√©",
            "claim": "üë§ Ticket R√©clam√©",
            "unclaim": "üîÑ Ticket Lib√©r√©"
        }

        embed = discord.Embed(
            title=action_titles.get(action, "üìã Action Ticket"),
            color=action_colors.get(action, discord.Color.blue()),
            timestamp=datetime.now(timezone.utc)
        )

        embed.add_field(name="üë§ Utilisateur", value=f"{user.mention} ({user.id})", inline=True)
        embed.add_field(name="üìç Canal", value=f"{channel.mention}" if channel else "Canal supprim√©", inline=True)

        if extra_info:
            embed.add_field(name="‚ÑπÔ∏è D√©tails", value=extra_info, inline=False)

        embed.set_thumbnail(url=user.display_avatar.url)

        try:
            await logs_channel.send(embed=embed)
        except discord.Forbidden:
            pass

class TicketManagement(discord.ui.View):
    def __init__(self):
        super().__init__(timeout=None)

    @discord.ui.button(label="Fermer", style=discord.ButtonStyle.danger, emoji="üîí", custom_id="ticket_close")
    async def close_ticket(self, interaction: discord.Interaction, button: discord.ui.Button):
        await interaction.response.send_modal(CloseTicketModal())

    @discord.ui.button(label="Claim", style=discord.ButtonStyle.success, emoji="üë§", custom_id="ticket_claim")
    async def claim_ticket(self, interaction: discord.Interaction, button: discord.ui.Button):
        config = load_tickets_config()

        # V√©rifier si l'utilisateur a les permissions
        if not self.has_ticket_permissions(interaction.user, config):
            await interaction.response.send_message("‚ùå Vous n'avez pas les permissions pour claim ce ticket.", ephemeral=True)
            return

        active_tickets = load_active_tickets()
        ticket_data = active_tickets.get(str(interaction.channel.id))

        if not ticket_data:
            await interaction.response.send_message("‚ùå Ce ticket n'est pas enregistr√©.", ephemeral=True)
            return

        if ticket_data.get("claimed_by"):
            claimer = interaction.guild.get_member(ticket_data["claimed_by"])
            await interaction.response.send_message(f"‚ùå Ce ticket est d√©j√† claim par {claimer.mention if claimer else 'un membre du staff'}.", ephemeral=True)
            return

        # Claim le ticket
        ticket_data["claimed_by"] = interaction.user.id
        active_tickets[str(interaction.channel.id)] = ticket_data
        save_active_tickets(active_tickets)

        embed = discord.Embed(
            title="üë§ Ticket Claim",
            description=f"{interaction.user.mention} s'occupe maintenant de ce ticket.",
            color=discord.Color.blue(),
            timestamp=datetime.now(timezone.utc)
        )

        await interaction.response.send_message(embed=embed)

        # Log l'action
        panel = TicketPanel()
        await panel.log_ticket_action(interaction.guild, "claim", interaction.user, interaction.channel)

    @discord.ui.button(label="Transcript", style=discord.ButtonStyle.secondary, emoji="üìú", custom_id="ticket_transcript")
    async def transcript_ticket(self, interaction: discord.Interaction, button: discord.ui.Button):
        config = load_tickets_config()

        if not self.has_ticket_permissions(interaction.user, config):
            await interaction.response.send_message("‚ùå Vous n'avez pas les permissions pour g√©n√©rer un transcript.", ephemeral=True)
            return

        await interaction.response.defer(ephemeral=True)

        try:
            # G√©n√©rer le transcript
            transcript_file = await self.generate_transcript(interaction.channel)

            # Cr√©er un fichier
            filename = f"transcript-{interaction.channel.name}.txt"
            file = discord.File(transcript_file, filename=filename)

            await interaction.followup.send("üìú Transcript du ticket:", file=file, ephemeral=True)

        except Exception as e:
            await interaction.followup.send(f"‚ùå Erreur lors de la g√©n√©ration du transcript: {str(e)}", ephemeral=True)

    def has_ticket_permissions(self, user, config):
        """V√©rifier si l'utilisateur a les permissions pour g√©rer les tickets"""
        if user.guild_permissions.administrator:
            return True

        user_role_ids = [role.id for role in user.roles]
        return (config["staff_role_id"] in user_role_ids or
                config["support_role_id"] in user_role_ids)

    async def generate_transcript(self, channel):
        """G√©n√©rer un transcript du ticket"""
        messages = []
        async for message in channel.history(limit=None, oldest_first=True):
            timestamp = message.created_at.strftime("%Y-%m-%d %H:%M:%S")
            author = f"{message.author.display_name} ({message.author.id})"
            content = message.content or "[Message vide ou embed]"

            if message.attachments:
                content += "\n[Fichiers joints: " + ", ".join(att.filename for att in message.attachments) + "]"

            messages.append(f"[{timestamp}] {author}: {content}")

        transcript_content = f"""=== TRANSCRIPT DU TICKET ===
Canal: {channel.name}
G√©n√©r√© le: {datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M:%S")} UTC
Nombre de messages: {len(messages)}

{'='*50}

""" + "\n".join(messages)

        # Cr√©er un objet BytesIO au lieu de retourner directement les bytes
        transcript_file = io.BytesIO(transcript_content.encode('utf-8'))
        transcript_file.seek(0)
        return transcript_file

class CloseTicketModal(discord.ui.Modal):
    def __init__(self):
        super().__init__(title="Fermer le Ticket")

    reason = discord.ui.TextInput(
        label="Raison de la fermeture",
        placeholder="Pourquoi fermez-vous ce ticket ?",
        required=False,
        max_length=500
    )

    async def on_submit(self, interaction: discord.Interaction):
        config = load_tickets_config()
        active_tickets = load_active_tickets()

        ticket_data = active_tickets.get(str(interaction.channel.id))
        if not ticket_data:
            await interaction.response.send_message("‚ùå Ce ticket n'est pas enregistr√©.", ephemeral=True)
            return

        # G√©n√©rer le transcript automatiquement
        ticket_mgmt = TicketManagement()
        transcript_file = await ticket_mgmt.generate_transcript(interaction.channel)
        filename = f"transcript-{interaction.channel.name}.txt"

        # Envoyer le transcript au cr√©ateur du ticket
        ticket_creator = interaction.guild.get_member(ticket_data["user_id"])
        if ticket_creator:
            try:
                embed = discord.Embed(
                    title="üîí Ticket Ferm√©",
                    description=f"Votre ticket sur **{interaction.guild.name}** a √©t√© ferm√©.",
                    color=discord.Color.red(),
                    timestamp=datetime.now(timezone.utc)
                )

                if self.reason.value:
                    embed.add_field(name="üìù Raison", value=self.reason.value, inline=False)

                embed.add_field(name="üë§ Ferm√© par", value=interaction.user.display_name, inline=True)
                embed.set_footer(text="Merci d'avoir utilis√© notre syst√®me de support !")

                # Cr√©er une copie du transcript pour l'utilisateur
                transcript_file.seek(0)
                user_file = discord.File(io.BytesIO(transcript_file.read()), filename=filename)
                await ticket_creator.send(embed=embed, file=user_file)
            except discord.Forbidden:
                pass

        # Envoyer le transcript dans les logs
        if config["logs_channel_id"]:
            logs_channel = interaction.guild.get_channel(config["logs_channel_id"])
            if logs_channel:
                try:
                    log_embed = discord.Embed(
                        title="üîí Ticket Ferm√©",
                        color=discord.Color.red(),
                        timestamp=datetime.now(timezone.utc)
                    )
                    log_embed.add_field(name="üë§ Cr√©ateur", value=f"<@{ticket_data['user_id']}>", inline=True)
                    log_embed.add_field(name="üë§ Ferm√© par", value=interaction.user.mention, inline=True)
                    log_embed.add_field(name="üìç Canal", value=f"#{interaction.channel.name}", inline=True)

                    if self.reason.value:
                        log_embed.add_field(name="üìù Raison", value=self.reason.value, inline=False)

                    # Cr√©er une copie du transcript pour les logs
                    transcript_file.seek(0)
                    logs_file = discord.File(io.BytesIO(transcript_file.read()), filename=filename)
                    await logs_channel.send(embed=log_embed, file=logs_file)
                except discord.Forbidden:
                    pass

        # Supprimer le ticket des tickets actifs
        if str(interaction.channel.id) in active_tickets:
            del active_tickets[str(interaction.channel.id)]
            save_active_tickets(active_tickets)

        # Message de fermeture
        embed = discord.Embed(
            title="üîí Fermeture du Ticket",
            description="Ce ticket sera supprim√© dans 10 secondes...",
            color=discord.Color.red()
        )

        if self.reason.value:
            embed.add_field(name="üìù Raison", value=self.reason.value, inline=False)

        await interaction.response.send_message(embed=embed)

        # Attendre et supprimer le canal
        await asyncio.sleep(10)
        try:
            await interaction.channel.delete(reason=f"Ticket ferm√© par {interaction.user}")
        except discord.NotFound:
            pass

class Tickets(commands.Cog):
    def __init__(self, client):
        self.client = client
        # Ajouter les vues persistantes au d√©marrage
        self.client.add_view(TicketPanel())
        self.client.add_view(TicketManagement())

    @app_commands.command(name="setup_tickets", description="Configurer le syst√®me de tickets")
    @app_commands.default_permissions(administrator=True)
    async def setup_tickets(self, inter: discord.Interaction):
        await inter.response.send_message("‚öôÔ∏è Configuration du syst√®me de tickets en cours...", ephemeral=True)

        try:
            config = load_tickets_config()
            guild = inter.guild

            # Cr√©er la cat√©gorie des tickets
            if config["category_id"] == 0:
                tickets_category = await guild.create_category(
                    "üé´ ‚îÅ‚îÅ‚îÅ TICKETS ‚îÅ‚îÅ‚îÅ",
                    reason="Cat√©gorie pour le syst√®me de tickets"
                )
                config["category_id"] = tickets_category.id

            # Cr√©er le canal des logs
            if config["logs_channel_id"] == 0:
                logs_category = discord.utils.get(guild.categories, name="üìÅ„ÉªEspace logs")
                if not logs_category:
                    logs_category = await guild.create_category("üìÅ„ÉªEspace logs")

                logs_channel = await guild.create_text_channel(
                    "üìÅ„Éªlogs-tickets",
                    category=logs_category,
                    reason="Canal de logs pour les tickets"
                )
                config["logs_channel_id"] = logs_channel.id

                # Permissions du canal logs
                await logs_channel.set_permissions(guild.default_role, read_messages=False)

            save_tickets_config(config)

            # R√©ponse de succ√®s
            category = guild.get_channel(config["category_id"])
            logs = guild.get_channel(config["logs_channel_id"])

            embed = discord.Embed(
                title="‚úÖ Configuration des Tickets termin√©e",
                description="Le syst√®me de tickets a √©t√© configur√© avec succ√®s !",
                color=discord.Color.green()
            )
            embed.add_field(name="üìä Statut", value="‚ùå D√©sactiv√©" if not config["enabled"] else "‚úÖ Activ√©", inline=True)
            embed.add_field(name="üìÅ Cat√©gorie", value=category.mention if category else "‚ùå Erreur", inline=True)
            embed.add_field(name="üìù Logs", value=logs.mention if logs else "‚ùå Erreur", inline=True)
            embed.add_field(name="üé´ Tickets cr√©√©s", value=f"{config['ticket_counter']}", inline=True)
            embed.add_field(name="üìä Max par utilisateur", value=f"{config['max_tickets_per_user']}", inline=True)

            await inter.edit_original_response(content=None, embed=embed)

        except Exception as e:
            error_embed = discord.Embed(
                title="‚ùå Erreur de Configuration",
                description=f"Erreur lors de la configuration : {str(e)}",
                color=discord.Color.red()
            )
            await inter.edit_original_response(content=None, embed=error_embed)

    @app_commands.command(name="toggle_tickets", description="Activer ou d√©sactiver le syst√®me de tickets")
    @app_commands.default_permissions(administrator=True)
    async def toggle_tickets(self, inter: discord.Interaction):
        config = load_tickets_config()
        config["enabled"] = not config["enabled"]
        save_tickets_config(config)

        status = "‚úÖ activ√©" if config["enabled"] else "‚ùå d√©sactiv√©"
        embed = discord.Embed(
            title="üîÑ Syst√®me de Tickets mis √† jour",
            description=f"Le syst√®me de tickets est maintenant {status}",
            color=discord.Color.green() if config["enabled"] else discord.Color.red()
        )
        await inter.response.send_message(embed=embed, ephemeral=True)

    @app_commands.command(name="ticket_panel", description="Cr√©er le panel de cr√©ation de tickets")
    @app_commands.default_permissions(administrator=True)
    async def ticket_panel(self, inter: discord.Interaction, channel: discord.TextChannel = None):
        config = load_tickets_config()

        if not config["enabled"]:
            await inter.response.send_message("‚ùå Le syst√®me de tickets est d√©sactiv√©. Activez-le avec `/toggle_tickets`.", ephemeral=True)
            return

        target_channel = channel or inter.channel

        # Cr√©er l'embed du panel
        embed = discord.Embed(
            title="üé´ Syst√®me de Support",
            description="Besoin d'aide ? Cr√©ez un ticket en cliquant sur l'un des boutons ci-dessous selon votre demande.",
            color=discord.Color.blue()
        )

        embed.add_field(
            name="üé´ Support G√©n√©ral",
            value="Questions g√©n√©rales et aide",
            inline=True
        )
        embed.add_field(
            name="üêõ Report de Bug",
            value="Signaler un probl√®me technique",
            inline=True
        )
        embed.add_field(
            name="‚ùì Autre",
            value="Autres demandes",
            inline=True
        )

        embed.add_field(
            name="üìã Instructions",
            value="‚Ä¢ Un seul ticket par probl√®me\n‚Ä¢ Soyez pr√©cis dans votre demande\n‚Ä¢ Restez poli et patient\n‚Ä¢ Un staff vous r√©pondra rapidement",
            inline=False
        )

        embed.set_footer(text="Syst√®me de tickets ‚Ä¢ Cliquez sur un bouton pour commencer")

        view = TicketPanel()

        try:
            message = await target_channel.send(embed=embed, view=view)

            # Sauvegarder l'ID du message du panel
            config["panel_channel_id"] = target_channel.id
            config["panel_message_id"] = message.id
            save_tickets_config(config)

            await inter.response.send_message(f"‚úÖ Panel de tickets cr√©√© dans {target_channel.mention}", ephemeral=True)

        except discord.Forbidden:
            await inter.response.send_message("‚ùå Je n'ai pas les permissions pour envoyer des messages dans ce canal.", ephemeral=True)

    @app_commands.command(name="tickets_config", description="Configurer les param√®tres des tickets")
    @app_commands.default_permissions(administrator=True)
    async def tickets_config(self, inter: discord.Interaction,
                           staff_role: discord.Role = None,
                           support_role: discord.Role = None,
                           max_tickets: int = None):

        config = load_tickets_config()

        if staff_role:
            config["staff_role_id"] = staff_role.id

        if support_role:
            config["support_role_id"] = support_role.id

        if max_tickets is not None:
            if max_tickets < 1 or max_tickets > 10:
                await inter.response.send_message("‚ùå Le nombre maximum de tickets par utilisateur doit √™tre entre 1 et 10.", ephemeral=True)
                return
            config["max_tickets_per_user"] = max_tickets

        save_tickets_config(config)

        embed = discord.Embed(
            title="‚öôÔ∏è Configuration des Tickets mise √† jour",
            color=discord.Color.blue()
        )

        if staff_role:
            embed.add_field(name="üë®‚Äçüíº R√¥le Staff", value=staff_role.mention, inline=True)
        if support_role:
            embed.add_field(name="üéß R√¥le Support", value=support_role.mention, inline=True)
        if max_tickets:
            embed.add_field(name="üìä Max tickets/utilisateur", value=str(max_tickets), inline=True)

        await inter.response.send_message(embed=embed, ephemeral=True)

    @app_commands.command(name="tickets_status", description="Afficher le statut du syst√®me de tickets")
    @app_commands.default_permissions(administrator=True)
    async def tickets_status(self, inter: discord.Interaction):
        config = load_tickets_config()
        active_tickets = load_active_tickets()
        guild = inter.guild

        # Compter les tickets par statut
        open_tickets = len([t for t in active_tickets.values() if t["status"] == "open"])
        claimed_tickets = len([t for t in active_tickets.values() if t.get("claimed_by")])

        embed = discord.Embed(
            title="üé´ Statut du Syst√®me de Tickets",
            color=discord.Color.blue() if config["enabled"] else discord.Color.greyple()
        )

        # Statut g√©n√©ral
        status_value = "‚úÖ Activ√©" if config["enabled"] else "‚ùå D√©sactiv√©"
        embed.add_field(name="üìä Statut", value=status_value, inline=True)
        embed.add_field(name="üé´ Tickets ouverts", value=f"{open_tickets}", inline=True)
        embed.add_field(name="üë§ Tickets claim", value=f"{claimed_tickets}", inline=True)

        # Configuration
        embed.add_field(name="üìà Total cr√©√©s", value=f"{config['ticket_counter']}", inline=True)
        embed.add_field(name="üìä Max par utilisateur", value=f"{config['max_tickets_per_user']}", inline=True)

        # R√¥les et canaux
        category = guild.get_channel(config["category_id"])
        logs_channel = guild.get_channel(config["logs_channel_id"])
        staff_role = guild.get_role(config["staff_role_id"])
        support_role = guild.get_role(config["support_role_id"])

        embed.add_field(name="üìÅ Cat√©gorie", value=category.mention if category else "‚ùå Non configur√©", inline=True)
        embed.add_field(name="üìù Canal logs", value=logs_channel.mention if logs_channel else "‚ùå Non configur√©", inline=True)

        if staff_role or support_role:
            roles_text = ""
            if staff_role:
                roles_text += f"**Staff:** {staff_role.mention}\n"
            if support_role:
                roles_text += f"**Support:** {support_role.mention}"
            embed.add_field(name="üë• R√¥les", value=roles_text, inline=False)

        await inter.response.send_message(embed=embed, ephemeral=True)

    @app_commands.command(name="force_close", description="Forcer la fermeture d'un ticket")
    @app_commands.default_permissions(administrator=True)
    async def force_close(self, inter: discord.Interaction, channel: discord.TextChannel = None):
        target_channel = channel or inter.channel
        active_tickets = load_active_tickets()

        ticket_data = active_tickets.get(str(target_channel.id))
        if not ticket_data:
            await inter.response.send_message("‚ùå Ce canal n'est pas un ticket enregistr√©.", ephemeral=True)
            return

        # G√©n√©rer transcript
        ticket_mgmt = TicketManagement()
        transcript_file = await ticket_mgmt.generate_transcript(target_channel)
        filename = f"transcript-{target_channel.name}.txt"

        # Envoyer le transcript au cr√©ateur
        ticket_creator = inter.guild.get_member(ticket_data["user_id"])
        if ticket_creator:
            try:
                embed = discord.Embed(
                    title="üîí Ticket Ferm√© (Force)",
                    description=f"Votre ticket sur **{inter.guild.name}** a √©t√© ferm√© par un administrateur.",
                    color=discord.Color.red()
                )
                embed.add_field(name="üë§ Ferm√© par", value=inter.user.display_name, inline=True)

                transcript_file.seek(0)
                file = discord.File(io.BytesIO(transcript_file.read()), filename=filename)
                await ticket_creator.send(embed=embed, file=file)
            except discord.Forbidden:
                pass

        # Supprimer du registre
        if str(target_channel.id) in active_tickets:
            del active_tickets[str(target_channel.id)]
            save_active_tickets(active_tickets)

        await inter.response.send_message("‚úÖ Le ticket sera ferm√© dans 5 secondes...", ephemeral=True)

        await asyncio.sleep(5)
        try:
            await target_channel.delete(reason=f"Ticket ferm√© de force par {inter.user}")
        except discord.NotFound:
            pass

    @app_commands.command(name="ticket_add", description="Ajouter un utilisateur √† un ticket")
    @app_commands.default_permissions(manage_channels=True)
    async def ticket_add(self, inter: discord.Interaction, user: discord.Member, channel: discord.TextChannel = None):
        target_channel = channel or inter.channel
        active_tickets = load_active_tickets()

        if str(target_channel.id) not in active_tickets:
            await inter.response.send_message("‚ùå Ce canal n'est pas un ticket enregistr√©.", ephemeral=True)
            return

        try:
            await target_channel.set_permissions(user, read_messages=True, send_messages=True)

            embed = discord.Embed(
                title="üë§ Utilisateur Ajout√©",
                description=f"{user.mention} a √©t√© ajout√© √† ce ticket par {inter.user.mention}.",
                color=discord.Color.green()
            )

            await target_channel.send(embed=embed)
            await inter.response.send_message(f"‚úÖ {user.mention} a √©t√© ajout√© au ticket.", ephemeral=True)

        except discord.Forbidden:
            await inter.response.send_message("‚ùå Je n'ai pas les permissions pour modifier ce canal.", ephemeral=True)

    @app_commands.command(name="ticket_remove", description="Retirer un utilisateur d'un ticket")
    @app_commands.default_permissions(manage_channels=True)
    async def ticket_remove(self, inter: discord.Interaction, user: discord.Member, channel: discord.TextChannel = None):
        target_channel = channel or inter.channel
        active_tickets = load_active_tickets()

        if str(target_channel.id) not in active_tickets:
            await inter.response.send_message("‚ùå Ce canal n'est pas un ticket enregistr√©.", ephemeral=True)
            return

        # Ne pas permettre de retirer le cr√©ateur du ticket
        ticket_data = active_tickets[str(target_channel.id)]
        if user.id == ticket_data["user_id"]:
            await inter.response.send_message("‚ùå Vous ne pouvez pas retirer le cr√©ateur du ticket.", ephemeral=True)
            return

        try:
            await target_channel.set_permissions(user, overwrite=None)

            embed = discord.Embed(
                title="üë§ Utilisateur Retir√©",
                description=f"{user.mention} a √©t√© retir√© de ce ticket par {inter.user.mention}.",
                color=discord.Color.orange()
            )

            await target_channel.send(embed=embed)
            await inter.response.send_message(f"‚úÖ {user.mention} a √©t√© retir√© du ticket.", ephemeral=True)

        except discord.Forbidden:
            await inter.response.send_message("‚ùå Je n'ai pas les permissions pour modifier ce canal.", ephemeral=True)

async def setup(client):
    await client.add_cog(Tickets(client))